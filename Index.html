<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sponsor System - Member</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style> 
        body { font-family: 'Prompt', sans-serif; } 
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <div id="auth-page" class="flex items-center justify-center min-h-screen p-4 bg-gradient-to-br from-emerald-500 to-teal-700">
        
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md relative overflow-hidden fade-in">
            <div class="absolute top-0 left-0 w-full h-2 bg-emerald-500"></div>

            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-emerald-600 tracking-tight"><i class="fa-solid fa-leaf"></i> SPON-HUB</h1>
                <p class="text-gray-400 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏õ‡∏≠‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</p>
            </div>

            <div id="login-form">
                <h2 class="text-xl font-bold mb-4 text-gray-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition">
                    <input type="password" id="login-pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition">
                    
                    <button onclick="login()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-lg shadow-emerald-200 transition transform active:scale-95">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
                <p class="text-center mt-6 text-sm text-gray-500">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <button onclick="toggleAuth('register')" class="text-emerald-600 font-bold hover:underline">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </p>
            </div>

            <div id="register-form" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-gray-700">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
                <div class="space-y-4">
                    <input type="text" id="reg-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô / ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition">
                    <input type="email" id="reg-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition">
                    <input type="password" id="reg-pass" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none transition">
                    
                    <button onclick="register()" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95">
                        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                    </button>
                </div>
                <p class="text-center mt-6 text-sm text-gray-500">
                    ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? <button onclick="toggleAuth('login')" class="text-emerald-600 font-bold hover:underline">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </p>
            </div>

        </div>
    </div>

    <div id="dashboard-page" class="hidden min-h-screen flex flex-col">
        <nav class="bg-white shadow-sm border-b px-6 py-4 flex justify-between items-center sticky top-0 z-50">
            <div class="font-bold text-xl text-emerald-600 flex items-center gap-2">
                <i class="fa-solid fa-leaf"></i> SPON-HUB
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <div id="nav-username" class="text-sm font-bold text-gray-800">User</div>
                    <div id="nav-email" class="text-xs text-gray-500">Loading...</div>
                </div>
                <button onclick="logout()" class="bg-red-50 text-red-500 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-100 transition">
                    <i class="fa-solid fa-power-off"></i> ‡∏≠‡∏≠‡∏Å
                </button>
            </div>
        </nav>

        <div class="flex-1 max-w-6xl mx-auto w-full p-6 grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-emerald-400 to-teal-500 z-0"></div>
                    <div class="relative z-10 pt-8">
                        <div class="w-24 h-24 bg-white p-1 rounded-full mx-auto shadow-md">
                            <div class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-4xl">üë§</div>
                        </div>
                        <h3 id="profile-name" class="text-xl font-bold mt-3 text-gray-800">...</h3>
                        
                        <div id="reputation-badge" class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-sm font-bold bg-gray-100 text-gray-500 mt-2">
                            <span class="w-2 h-2 rounded-full bg-gray-400"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-emerald-500">
                    <h4 class="font-bold text-emerald-700 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-bullhorn"></i> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                    </h4>
                    <p id="announcement-text" class="text-sm text-gray-600 leading-relaxed bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®...
                    </p>
                </div>
            </div>

            <div class="md:col-span-2 space-y-6">
                
                <div id="status-banner" class="hidden fade-in"></div>

                <div id="application-form" class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 hidden fade-in">
                    <div class="flex items-center gap-3 mb-6 border-b pb-4">
                        <div class="bg-emerald-100 p-3 rounded-lg text-emerald-600"><i class="fa-solid fa-pen-nib text-xl"></i></div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">‡∏¢‡∏∑‡πà‡∏ô‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏õ‡∏≠‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</h3>
                            <p class="text-sm text-gray-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏à‡∏£‡∏¥‡∏á)</label>
                            <input type="text" id="app-fullname" class="w-full border-gray-300 rounded-lg p-3 bg-gray-50 focus:bg-white border focus:ring-2 focus:ring-emerald-200 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (Facebook / Line / Discord)</label>
                            <input type="text" id="app-link" class="w-full border-gray-300 rounded-lg p-3 bg-gray-50 focus:bg-white border focus:ring-2 focus:ring-emerald-200 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏™‡∏õ‡∏≠‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå / ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
                            <textarea id="app-reason" rows="3" class="w-full border-gray-300 rounded-lg p-3 bg-gray-50 focus:bg-white border focus:ring-2 focus:ring-emerald-200 outline-none transition"></textarea>
                        </div>
                        <button onclick="submitApplication()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-md transition">
                            üöÄ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-5 border-b flex items-center justify-between bg-gray-50">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2">
                            <i class="fa-solid fa-clock-rotate-left text-emerald-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-white text-gray-500 border-b">
                                <tr>
                                    <th class="p-4 font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="p-4 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="p-4 font-medium text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                </tr>
                            </thead>
                            <tbody id="history-list" class="divide-y divide-gray-100">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const firebaseConfig = {
            apiKey: "AIzaSyDmon8gBvojsAitNY3AvyzmLAzQ_3pIXQI",
            authDomain: "rspon-8846f.firebaseapp.com",
            projectId: "rspon-8846f",
            storageBucket: "rspon-8846f.firebasestorage.app",
            messagingSenderId: "664672753380",
            appId: "1:664672753380:web:db68d4a61c56c505823ef1",
            measurementId: "G-W9D6EL9660"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- AUTH SYSTEM (FIXED) ---
        window.toggleAuth = (mode) => {
            if(mode === 'register') {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            } else {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }
        };

        window.login = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + parseError(e.code));
            }
        };

        window.register = async () => {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;

            if(!name || !email || !pass) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            if(pass.length < 6) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß");

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÉ‡∏ô Database
                await setDoc(doc(db, "users", cred.user.uid), {
                    displayName: name,
                    email: email,
                    role: 'user',
                    reputation: 'normal',
                    createdAt: new Date()
                });
                alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö");
            } catch (e) {
                alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + parseError(e.code));
            }
        };

        window.logout = () => signOut(auth);

        function parseError(code) {
            if(code === 'auth/email-already-in-use') return "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß";
            if(code === 'auth/wrong-password') return "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î";
            if(code === 'auth/user-not-found') return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ";
            if(code === 'auth/weak-password') return "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ";
            return code;
        }

        // --- CORE LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-page').classList.add('hidden');
                document.getElementById('dashboard-page').classList.remove('hidden');
                loadUserData(user.uid);
                checkApplication(user.uid);
                loadHistory(user.uid);
                loadAnnouncement();
            } else {
                document.getElementById('auth-page').classList.remove('hidden');
                document.getElementById('dashboard-page').classList.add('hidden');
                document.getElementById('login-email').value = "";
                document.getElementById('login-pass').value = "";
            }
        });

        function loadUserData(uid) {
            onSnapshot(doc(db, "users", uid), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    document.getElementById('nav-username').innerText = data.displayName || "Member";
                    document.getElementById('nav-email').innerText = data.email;
                    document.getElementById('profile-name').innerText = data.displayName || "Member";

                    const badge = document.getElementById('reputation-badge');
                    if(data.reputation === 'good') {
                        badge.className = "inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-sm font-bold bg-green-100 text-green-700";
                        badge.innerHTML = '<i class="fa-solid fa-circle-check"></i> ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
                    } else if (data.reputation === 'bad') {
                        badge.className = "inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-sm font-bold bg-red-100 text-red-700";
                        badge.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> ‡∏ï‡∏¥‡∏î Blacklist';
                    } else {
                        badge.className = "inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-sm font-bold bg-gray-100 text-gray-600";
                        badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-gray-400"></span> ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏õ‡∏Å‡∏ï‡∏¥';
                    }
                }
            });
        }

        function checkApplication(uid) {
            const q = query(collection(db, "applications"), where("uid", "==", uid));
            onSnapshot(q, (snapshot) => {
                const form = document.getElementById('application-form');
                const banner = document.getElementById('status-banner');

                if (snapshot.empty) {
                    form.classList.remove('hidden');
                    banner.classList.add('hidden');
                } else {
                    form.classList.add('hidden');
                    banner.classList.remove('hidden');
                    
                    const data = snapshot.docs[0].data();
                    if(data.status === 'pending') {
                        banner.className = "bg-yellow-50 border border-yellow-200 rounded-2xl p-6 text-center shadow-sm";
                        banner.innerHTML = `
                            <div class="text-3xl text-yellow-500 mb-2"><i class="fa-solid fa-hourglass-half"></i></div>
                            <h3 class="font-bold text-xl text-yellow-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <p class="text-yellow-700">‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</p>
                        `;
                    } else if (data.status === 'accepted') {
                        banner.className = "bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-6 text-white text-center shadow-lg";
                        banner.innerHTML = `
                            <div class="text-4xl mb-2 animate-bounce"><i class="fa-solid fa-circle-check"></i></div>
                            <h3 class="font-bold text-2xl">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                            <p class="text-emerald-50 opacity-90">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏õ‡∏≠‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                        `;
                    } else {
                        banner.className = "bg-red-50 border border-red-200 rounded-2xl p-6 text-center shadow-sm";
                        banner.innerHTML = `
                            <div class="text-3xl text-red-500 mb-2"><i class="fa-solid fa-circle-xmark"></i></div>
                            <h3 class="font-bold text-xl text-red-800">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</h3>
                            <p class="text-red-600">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏´‡∏ô‡πâ‡∏≤</p>
                        `;
                    }
                }
            });
        }

        window.submitApplication = async () => {
            const fullname = document.getElementById('app-fullname').value;
            const link = document.getElementById('app-link').value;
            const reason = document.getElementById('app-reason').value;

            if(!fullname || !link || !reason) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á");

            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£? (‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)")) {
                try {
                    await addDoc(collection(db, "applications"), {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: fullname, // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                        displayName: document.getElementById('profile-name').innerText, // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢
                        link, reason,
                        status: 'pending',
                        timestamp: new Date()
                    });
                } catch(e) { console.error(e); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
            }
        }

        function loadHistory(uid) {
            const q = query(collection(db, "transactions"), where("uid", "==", uid));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('history-list');
                tbody.innerHTML = "";
                if(snapshot.empty) {
                    tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</td></tr>`;
                    return;
                }
                
                // Sort client side for simplicity in demo (FireStore requires index for server sort)
                const docs = [];
                snapshot.forEach(doc => docs.push(doc.data()));
                docs.sort((a,b) => b.timestamp - a.timestamp);

                docs.forEach(d => {
                    const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleDateString('th-TH') : '-';
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 transition border-b border-gray-100 last:border-0">
                            <td class="p-4 text-gray-500 text-xs">${date}</td>
                            <td class="p-4 font-medium text-gray-800">${d.note || '‡∏£‡∏±‡∏ö‡∏™‡∏õ‡∏≠‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå'}</td>
                            <td class="p-4 text-right font-bold text-emerald-600">+${d.amount}</td>
                        </tr>
                    `;
                });
            });
        }

        function loadAnnouncement() {
            onSnapshot(doc(db, "settings", "announcement"), (doc) => {
                if(doc.exists()) {
                    document.getElementById('announcement-text').innerText = doc.data().text;
                }
            });
        }
    </script>
</body>
</html>
